<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./main.css" />
    <title>Document</title>
  </head>
  <body>
    <!--<a href="login.html">ログイン画面</a>-->
    <h1>チャット画面</h1>
    <!--テキスト表示画面-->
    <div id="id_chat_view_field">
      <!--書き込み済チャットテキスト-->
      <ul id="id_chat_list"></ul>
    </div>
    <!--入力場所，送信ボタン-->
    <div id="id_input_field">
      <input type="text" id="id_chat_input" />
      <input type="button" value="Send" id="id_button_chat_send" />
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script type="module">
      import { DataBaseAccessProxy } from "./databaseAccessProxy.js";

      // 送信済みチャットを画面表示する関数
      // text     :送信済みチャット
      // isMe     :チャット送信者が自分であるかのフラグ
      // userName :チャット送信者名
      function displayChat(text, isMe, userName) {
        // 一番下までスクロール
        const field = document.getElementById("id_chat_view_field");
        field.scroll(0, field.scrollHeight - field.clientHeight);

        const ul = document.getElementById("id_chat_list");
        const li = document.createElement("li");
        // このdivにテキストを指定
        const div = document.createElement("div");
        div.textContent = text;

        if (isMe) {
          // 自分
          div.classList.add("chat-right");
          li.classList.add("right");
          ul.appendChild(li);
          li.appendChild(div);
        } else {
          // 自分以外のユーザ
          li.classList.add("left");
          div.classList.add("chat-left");
          ul.appendChild(li);
          li.appendChild(div);
        }
      }

      // チャット送信ボタン
      $("#id_button_chat_send").on("click", () => {
        let postTargetText = $("#id_chat_input").val();

        // チャットテキスト送信
        DataBaseAccessProxy.PostChatText(postTargetText).then((postSuccess) => {
          //console.log(postSuccess);
          // 送信結果チェック
          if (postSuccess) {
            let isMe = true;
            let userName = "anonymous";
            displayChat(postTargetText, isMe, userName);
            console.log(postTargetText);
          } else {
            alert("チャット送信に失敗しました。");
          }
        });
      });
    </script>
  </body>
</html>
